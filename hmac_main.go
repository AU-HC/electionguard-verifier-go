package main

import (
	"electionguard-verifier-go/crypto"
	"electionguard-verifier-go/schema"
	"electionguard-verifier-go/utility"
	"fmt"
	"os"
)

const pString = "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFB17217F7D1CF79ABC9E3B39803F2F6AF40F343267298B62D8A0D175B8BAAFA2BE7B876206DEBAC98559552FB4AFA1B10ED2EAE35C138214427573B291169B8253E96CA16224AE8C51ACBDA11317C387EB9EA9BC3B136603B256FA0EC7657F74B72CE87B19D6548CAF5DFA6BD38303248655FA1872F20E3A2DA2D97C50F3FD5C607F4CA11FB5BFB90610D30F88FE551A2EE569D6DFC1EFA157D2E23DE1400B39617460775DB8990E5C943E732B479CD33CCCC4E659393514C4C1A1E0BD1D6095D25669B333564A3376A9C7F8A5E148E82074DB6015CFE7AA30C480A5417350D2C955D5179B1E17B9DAE313CDB6C606CB1078F735D1B2DB31B5F50B5185064C18B4D162DB3B365853D7598A1951AE273EE5570B6C68F96983496D4E6D330AF889B44A02554731CDC8EA17293D1228A4EF98D6F5177FBCF0755268A5C1F9538B98261AFFD446B1CA3CF5E9222B88C66D3C5422183EDC99421090BBB16FAF3D949F236E02B20CEE886B905C128D53D0BD2F9621363196AF503020060E49908391A0C57339BA2BEBA7D052AC5B61CC4E9207CEF2F0CE2D7373958D762265890445744FB5F2DA4B751005892D356890DEFE9CAD9B9D4B713E06162A2D8FDD0DF2FD608FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"
const qString = "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF43"
const gString = "36036FED214F3B50DC566D3A312FE4131FEE1C2BCE6D02EA39B477AC05F7F885F38CFE77A7E45ACF4029114C4D7A9BFE058BF2F995D2479D3DDA618FFD910D3C4236AB2CFDD783A5016F7465CF59BBF45D24A22F130F2D04FE93B2D58BB9C1D1D27FC9A17D2AF49A779F3FFBDCA22900C14202EE6C99616034BE35CBCDD3E7BB7996ADFE534B63CCA41E21FF5DC778EBB1B86C53BFBE99987D7AEA0756237FB40922139F90A62F2AA8D9AD34DFF799E33C857A6468D001ACF3B681DB87DC4242755E2AC5A5027DB81984F033C4D178371F273DBB4FCEA1E628C23E52759BC7765728035CEA26B44C49A65666889820A45C33DD37EA4A1D00CB62305CD541BE1E8A92685A07012B1A20A746C3591A2DB3815000D2AACCFE43DC49E828C1ED7387466AFD8E4BF1935593B2A442EEC271C50AD39F733797A1EA11802A2557916534662A6B7E9A9E449A24C8CFF809E79A4D806EB681119330E6C57985E39B200B4893639FDFDEA49F76AD1ACD997EBA13657541E79EC57437E504EDA9DD011061516C643FB30D6D58AFCCD28B73FEDA29EC12B01A5EB86399A593A9D5F450DE39CB92962C5EC6925348DB54D128FD99C14B457F883EC20112A75A6A0581D3D80A3B4EF09EC86F9552FFDA1653F133AA2534983A6F31B0EE4697935A6B1EA2F75B85E7EBA151BA486094D68722B054633FEC51CA3F29B31E77E317B178B6B9D8AE0F"

func main() {
	p := schema.MakeBigIntFromString(pString, 16)
	q := schema.MakeBigIntFromString(qString, 16)
	g := schema.MakeBigIntFromString(gString, 16)

	// Computing hashP
	ver := append(schema.MakeBigIntFromString("76322E302E30", 16).Bytes(), make([]byte, 27)...)
	hashP := crypto.HMAC(*schema.MakeBigIntFromByteArray(ver), 0x00, *p, *q, *g)
	expectedHashP := schema.MakeBigIntFromString("2B3B025E50E09C119CBA7E9448ACD1CABC9447EF39BF06327D81C665CDD86296", 16)
	if !hashP.Compare(expectedHashP) {
		fmt.Println("Wanted hashP: ", expectedHashP)
		fmt.Println("Got hashP: ", hashP)
	}

	// Computing hashM
	manifest, err := os.ReadFile("data/manifest.json")
	utility.PanicError(err)
	hashM := crypto.HMAC(*hashP, 0x01, manifest)
	expectedHashM := schema.MakeBigIntFromString("2388DAE2DAD9E79ED64BD2C5401C361BDA77B9019EA8C6F416568185679B4854", 16)
	if !hashM.Compare(expectedHashM) {
		fmt.Println("Wanted hashM: ", expectedHashM)
		fmt.Println("Got hashM: ", hashM)
	}

	// Computing hashB
	got := crypto.HMAC(*hashP, 0x02, *hashM, 5, 3)

	wanted := new(schema.BigInt)
	wanted.SetString("8F91FBD8905679F8E7BB52D7BED30240BD1DB7EC4146646D1A2D1F92CAE41EDD", 16)

	hashIsIncorrect := !got.Compare(wanted)
	if hashIsIncorrect {
		fmt.Println(got)
		fmt.Println(wanted)
	}
}
